name: Health Check Monitoring

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  health-check:
    name: Production Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Check backend health
        id: backend-health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.BACKEND_URL }}/health)
          if [ $response -eq 200 ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "‚úÖ Backend is healthy (HTTP $response)"
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "‚ùå Backend is unhealthy (HTTP $response)"
            exit 1
          fi
      
      - name: Check frontend
        id: frontend-health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.FRONTEND_URL }})
          if [ $response -eq 200 ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "‚úÖ Frontend is healthy (HTTP $response)"
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "‚ùå Frontend is unhealthy (HTTP $response)"
            exit 1
          fi
      
      - name: Detailed API health check
        if: steps.backend-health.outputs.status == 'healthy'
        run: |
          # Check authentication endpoint
          curl -f ${{ secrets.BACKEND_URL }}/api/v1/auth/health || echo "‚ùå Auth endpoint failed"
          
          # Check API version
          curl -f ${{ secrets.BACKEND_URL }}/api/v1/health || echo "‚ùå API health check failed"
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "üö® Health check failed - immediate attention required!"
          # Add notification webhook here (Slack, Discord, PagerDuty, etc.)
