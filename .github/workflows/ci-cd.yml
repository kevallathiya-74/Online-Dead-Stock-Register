name: CI/CD Pipeline with Auto-Recovery

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'
  RETRY_ATTEMPTS: 3
  RETRY_DELAY: 5

jobs:
  # Backend tests and build with auto-recovery
  backend-test:
    name: Backend Tests & Build
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install backend dependencies with retry
        working-directory: ./backend
        run: |
          attempt=1
          max_attempts=${{ env.RETRY_ATTEMPTS }}
          while [ $attempt -le $max_attempts ]; do
            echo "üì¶ Installing dependencies (attempt $attempt/$max_attempts)..."
            if npm ci; then
              echo "‚úÖ Dependencies installed successfully"
              exit 0
            else
              echo "‚ö†Ô∏è Installation failed, retrying in ${{ env.RETRY_DELAY }}s..."
              sleep ${{ env.RETRY_DELAY }}
              attempt=$((attempt + 1))
            fi
          done
          echo "‚ùå Failed to install dependencies after $max_attempts attempts"
          exit 1
      
      - name: Auto-fix dependency vulnerabilities
        working-directory: ./backend
        continue-on-error: true
        run: |
          echo "üîí Checking for security vulnerabilities..."
          npm audit fix --force || echo "‚ö†Ô∏è Some vulnerabilities could not be auto-fixed"
      
      - name: Validate backend syntax
        working-directory: ./backend
        run: |
          echo "üîç Validating JavaScript syntax..."
          node -c server.js
          find . -name "*.js" -not -path "./node_modules/*" -exec node -c {} \;
          echo "‚úÖ Syntax validation passed"
      
      - name: Run backend tests with retry
        working-directory: ./backend
        run: |
          attempt=1
          max_attempts=${{ env.RETRY_ATTEMPTS }}
          while [ $attempt -le $max_attempts ]; do
            echo "üß™ Running tests (attempt $attempt/$max_attempts)..."
            if npm run test:ci; then
              echo "‚úÖ Tests passed"
              exit 0
            else
              echo "‚ö†Ô∏è Tests failed, retrying in ${{ env.RETRY_DELAY }}s..."
              sleep ${{ env.RETRY_DELAY }}
              attempt=$((attempt + 1))
            fi
          done
          echo "‚ùå Tests failed after $max_attempts attempts"
          exit 1
        env:
          MONGODB_URI: mongodb://localhost:27017/test_db
          JWT_SECRET: test_jwt_secret_minimum_32_characters_long_for_testing
          NODE_ENV: test
      
      - name: Upload backend coverage
        if: always()
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          files: ./backend/coverage/lcov.info
          flags: backend
          name: backend-coverage
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
      
      - name: Archive backend artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-artifacts
          path: |
            backend/coverage
            backend/package-lock.json
          retention-days: 30

  # Frontend tests and build with auto-recovery
  frontend-test:
    name: Frontend Tests & Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install frontend dependencies with retry
        run: |
          attempt=1
          max_attempts=${{ env.RETRY_ATTEMPTS }}
          while [ $attempt -le $max_attempts ]; do
            echo "üì¶ Installing dependencies (attempt $attempt/$max_attempts)..."
            if npm ci; then
              echo "‚úÖ Dependencies installed successfully"
              exit 0
            else
              echo "‚ö†Ô∏è Installation failed, retrying in ${{ env.RETRY_DELAY }}s..."
              sleep ${{ env.RETRY_DELAY }}
              attempt=$((attempt + 1))
            fi
          done
          echo "‚ùå Failed to install dependencies after $max_attempts attempts"
          exit 1
      
      - name: Auto-fix dependency vulnerabilities
        continue-on-error: true
        run: |
          echo "üîí Checking for security vulnerabilities..."
          npm audit fix --force || echo "‚ö†Ô∏è Some vulnerabilities could not be auto-fixed"
      
      - name: TypeScript type check
        run: |
          echo "üîç Running TypeScript type check..."
          npx tsc --noEmit
          echo "‚úÖ Type check passed"
      
      - name: Run frontend tests
        run: npm test --if-present
        env:
          CI: true
      
      - name: Build frontend with retry
        run: |
          attempt=1
          max_attempts=${{ env.RETRY_ATTEMPTS }}
          while [ $attempt -le $max_attempts ]; do
            echo "üèóÔ∏è Building frontend (attempt $attempt/$max_attempts)..."
            if npm run build; then
              echo "‚úÖ Build successful"
              exit 0
            else
              echo "‚ö†Ô∏è Build failed, retrying in ${{ env.RETRY_DELAY }}s..."
              sleep ${{ env.RETRY_DELAY }}
              attempt=$((attempt + 1))
            fi
          done
          echo "‚ùå Build failed after $max_attempts attempts"
          exit 1
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL || 'https://online-dead-stock-register.onrender.com/api/v1' }}
      
      - name: Verify build output
        run: |
          echo "üìä Build verification..."
          if [ ! -d "dist" ]; then
            echo "‚ùå dist folder not found!"
            exit 1
          fi
          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå index.html not found in dist!"
            exit 1
          fi
          echo "‚úÖ Build output verified"
          du -sh dist/
          ls -lh dist/
      
      - name: Upload frontend build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: dist
          retention-days: 30
      
      - name: Upload frontend coverage
        if: always()
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          files: ./coverage/lcov.info
          flags: frontend
          name: frontend-coverage
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  # Security audit with auto-fix
  security-audit:
    name: Security Audit & Auto-Fix
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Audit and auto-fix backend
        working-directory: ./backend
        run: |
          echo "üîí Backend security audit..."
          npm audit --audit-level=moderate || true
          echo "üîß Attempting auto-fix..."
          npm audit fix --force || echo "‚ö†Ô∏è Some issues require manual intervention"
        continue-on-error: true
      
      - name: Audit and auto-fix frontend
        run: |
          echo "üîí Frontend security audit..."
          npm audit --audit-level=moderate || true
          echo "üîß Attempting auto-fix..."
          npm audit fix --force || echo "‚ö†Ô∏è Some issues require manual intervention"
        continue-on-error: true

  # Deploy backend to Render with health checks
  deploy-backend:
    name: Deploy Backend to Render
    needs: [backend-test, security-audit]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: production-backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Trigger Render deployment
        id: deploy
        run: |
          if [ -z "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" ]; then
            echo "‚ö†Ô∏è RENDER_DEPLOY_HOOK_URL not configured"
            echo "deployed=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "üöÄ Triggering Render deployment..."
          response=$(curl -s -o /dev/null -w "%{http_code}" -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}")
          
          if [ "$response" -eq 200 ] || [ "$response" -eq 201 ]; then
            echo "‚úÖ Deployment triggered successfully"
            echo "deployed=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Deployment trigger failed with status $response"
            echo "deployed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Wait for deployment to stabilize
        if: steps.deploy.outputs.deployed == 'true'
        run: |
          echo "‚è≥ Waiting for deployment to complete (90 seconds)..."
          sleep 90
      
      - name: Backend health check with retry
        if: steps.deploy.outputs.deployed == 'true'
        run: |
          if [ -z "${{ secrets.BACKEND_URL }}" ]; then
            echo "‚ö†Ô∏è BACKEND_URL not configured, skipping health check"
            exit 0
          fi
          
          attempt=1
          max_attempts=5
          while [ $attempt -le $max_attempts ]; do
            echo "üè• Health check (attempt $attempt/$max_attempts)..."
            response=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.BACKEND_URL }}/health" || echo "000")
            
            if [ "$response" -eq 200 ]; then
              echo "‚úÖ Backend is healthy!"
              exit 0
            else
              echo "‚ö†Ô∏è Health check returned status $response, retrying in 10s..."
              sleep 10
              attempt=$((attempt + 1))
            fi
          done
          
          echo "‚ùå Backend health check failed after $max_attempts attempts"
          exit 1
      
      - name: Verify API endpoints
        if: steps.deploy.outputs.deployed == 'true'
        continue-on-error: true
        run: |
          if [ -n "${{ secrets.BACKEND_URL }}" ]; then
            echo "üîç Verifying critical API endpoints..."
            
            # Check auth endpoint
            auth_status=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.BACKEND_URL }}/auth/health" || echo "000")
            echo "Auth endpoint: $auth_status"
            
            # Check settings endpoint (should return 401 without auth)
            settings_status=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.BACKEND_URL }}/settings" || echo "000")
            echo "Settings endpoint: $settings_status"
            
            echo "‚úÖ API verification complete"
          fi
      
      - name: Rollback on failure
        if: failure() && steps.deploy.outputs.deployed == 'true'
        run: |
          echo "‚ùå Deployment failed, initiating rollback..."
          if [ -n "${{ secrets.RENDER_ROLLBACK_HOOK_URL }}" ]; then
            curl -X POST "${{ secrets.RENDER_ROLLBACK_HOOK_URL }}"
            echo "üîÑ Rollback triggered"
          else
            echo "‚ö†Ô∏è RENDER_ROLLBACK_HOOK_URL not configured, manual rollback required"
          fi

  # Deploy frontend to Vercel with verification
  deploy-frontend:
    name: Deploy Frontend to Vercel
    needs: [frontend-test, deploy-backend]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: production-frontend
      url: https://online-dead-stock-register.vercel.app
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build for production
        run: npm run build
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL || 'https://online-dead-stock-register.onrender.com/api/v1' }}
      
      - name: Install Vercel CLI
        run: npm install --global vercel@latest
      
      - name: Pull Vercel Environment
        run: |
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "‚ö†Ô∏è VERCEL_TOKEN not configured"
            exit 1
          fi
          
          vercel pull --yes --environment=production \
            --token=${{ secrets.VERCEL_TOKEN }} \
            ${{ secrets.VERCEL_ORG_ID && format('--scope={0}', secrets.VERCEL_ORG_ID) || '' }}
      
      - name: Deploy to Vercel with retry
        id: vercel-deploy
        run: |
          attempt=1
          max_attempts=${{ env.RETRY_ATTEMPTS }}
          
          while [ $attempt -le $max_attempts ]; do
            echo "üöÄ Deploying to Vercel (attempt $attempt/$max_attempts)..."
            
            deployment_url=$(vercel deploy --prod \
              --token=${{ secrets.VERCEL_TOKEN }} \
              ${{ secrets.VERCEL_ORG_ID && format('--scope={0}', secrets.VERCEL_ORG_ID) || '' }} \
              2>&1 | grep -o 'https://[^ ]*' | head -1)
            
            if [ -n "$deployment_url" ]; then
              echo "‚úÖ Deployment successful: $deployment_url"
              echo "url=$deployment_url" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "‚ö†Ô∏è Deployment failed, retrying in ${{ env.RETRY_DELAY }}s..."
              sleep ${{ env.RETRY_DELAY }}
              attempt=$((attempt + 1))
            fi
          done
          
          echo "‚ùå Deployment failed after $max_attempts attempts"
          exit 1
      
      - name: Verify deployment with retry
        run: |
          if [ -z "${{ steps.vercel-deploy.outputs.url }}" ]; then
            echo "‚ö†Ô∏è No deployment URL found, skipping verification"
            exit 0
          fi
          
          attempt=1
          max_attempts=5
          deployment_url="${{ steps.vercel-deploy.outputs.url }}"
          
          while [ $attempt -le $max_attempts ]; do
            echo "üîç Verifying deployment (attempt $attempt/$max_attempts)..."
            
            response=$(curl -s -o /dev/null -w "%{http_code}" "$deployment_url" || echo "000")
            
            if [ "$response" -eq 200 ]; then
              echo "‚úÖ Frontend deployment verified!"
              exit 0
            else
              echo "‚ö†Ô∏è Verification returned status $response, retrying in 10s..."
              sleep 10
              attempt=$((attempt + 1))
            fi
          done
          
          echo "‚ùå Deployment verification failed after $max_attempts attempts"
          exit 1
      
      - name: Test critical routes
        continue-on-error: true
        run: |
          deployment_url="${{ steps.vercel-deploy.outputs.url }}"
          if [ -n "$deployment_url" ]; then
            echo "üß™ Testing critical frontend routes..."
            
            # Test login page
            login_status=$(curl -s -o /dev/null -w "%{http_code}" "$deployment_url/login" || echo "000")
            echo "Login page: $login_status"
            
            # Test assets exist
            echo "üì¶ Checking static assets..."
            curl -s "$deployment_url" | grep -q "script" && echo "‚úÖ Scripts loaded" || echo "‚ö†Ô∏è Script tags not found"
            
            echo "‚úÖ Route testing complete"
          fi

  # Post-deployment verification
  post-deploy-verification:
    name: Post-Deployment Verification
    needs: [deploy-backend, deploy-frontend]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    
    steps:
      - name: Full system health check
        run: |
          echo "üè• Running full system health check..."
          
          backend_url="${{ secrets.BACKEND_URL }}"
          frontend_url="https://online-dead-stock-register.vercel.app"
          
          # Backend health
          if [ -n "$backend_url" ]; then
            backend_status=$(curl -s -o /dev/null -w "%{http_code}" "$backend_url/health" || echo "000")
            echo "Backend health: $backend_status"
            
            if [ "$backend_status" -ne 200 ]; then
              echo "‚ùå Backend health check failed!"
              exit 1
            fi
          fi
          
          # Frontend health
          frontend_status=$(curl -s -o /dev/null -w "%{http_code}" "$frontend_url" || echo "000")
          echo "Frontend health: $frontend_status"
          
          if [ "$frontend_status" -ne 200 ]; then
            echo "‚ùå Frontend health check failed!"
            exit 1
          fi
          
          echo "‚úÖ All systems operational!"
      
      - name: Generate deployment report
        run: |
          echo "üìä Deployment Report"
          echo "===================="
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Backend URL: ${{ secrets.BACKEND_URL }}"
          echo "Frontend URL: https://online-dead-stock-register.vercel.app"
          echo "‚úÖ Deployment completed successfully!"

  # Notify on success
  notify-success:
    name: Notify Success
    needs: [post-deploy-verification]
    if: success() && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
      - name: Send success notification
        run: |
          echo "üéâ CI/CD Pipeline Completed Successfully!"
          echo "‚úÖ Backend deployed and healthy"
          echo "‚úÖ Frontend deployed and verified"
          echo "‚úÖ All post-deployment checks passed"

  # Notify and handle failures
  notify-failure:
    name: Handle Failure & Notify
    needs: [backend-test, frontend-test, deploy-backend, deploy-frontend]
    if: failure()
    runs-on: ubuntu-latest
    
    steps:
      - name: Identify failure point
        run: |
          echo "‚ùå CI/CD Pipeline Failed!"
          echo "Failure detected in workflow"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Actor: ${{ github.actor }}"
      
      - name: Suggest recovery actions
        run: |
          echo "üîß Recovery Actions:"
          echo "1. Check workflow logs for specific errors"
          echo "2. Verify all secrets are configured correctly"
          echo "3. Run tests locally before pushing"
          echo "4. Check Render/Vercel deployment status"
          echo "5. Consider manual rollback if needed"
